name: Daily Collection Run

on:
  schedule:
    - cron: "0 6 * * *" # 06:00 UTC daily
  workflow_dispatch: # manual trigger

jobs:
  collect:
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: |
          uv sync
          uv run playwright install --with-deps chromium

      - name: Run collector
        env:
          COLLECTOR_MONGO_URI: mongodb://localhost:27017
          COLLECTOR_LOG_JSON: "true"
        run: uv run collector collect 2>&1 | tee collect_output.json

      - name: Run ML pipeline
        env:
          COLLECTOR_MONGO_URI: mongodb://localhost:27017
        run: uv run collector process 2>&1 | tee process_output.json

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: collection-logs-${{ github.run_id }}
          path: |
            collect_output.json
            process_output.json
          retention-days: 30
